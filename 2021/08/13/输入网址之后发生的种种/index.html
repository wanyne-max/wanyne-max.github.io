<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>输入网址之后的种种 - Wanyne&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Wanyne&#039;s Blog"><meta name="msapplication-TileImage" content="/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Wanyne&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="在学习了部分网络知识后，我们可以大致的想象到在键入网址后，到网页显示出对应内容，其间发生了什么 接下来以简单的网络拓扑模型作为例子，探究一个数据包在网络中发生的种种。"><meta property="og:type" content="blog"><meta property="og:title" content="输入网址之后的种种"><meta property="og:url" content="https://wanyne-max.github.io/2021/08/13/%E8%BE%93%E5%85%A5%E7%BD%91%E5%9D%80%E4%B9%8B%E5%90%8E%E5%8F%91%E7%94%9F%E7%9A%84%E7%A7%8D%E7%A7%8D/"><meta property="og:site_name" content="Wanyne&#039;s Blog"><meta property="og:description" content="在学习了部分网络知识后，我们可以大致的想象到在键入网址后，到网页显示出对应内容，其间发生了什么 接下来以简单的网络拓扑模型作为例子，探究一个数据包在网络中发生的种种。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.1hxfibtd6mu8.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/URL%E8%A7%A3%E6%9E%90.1qgqj3vqzdvk.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/HTTP%E7%9A%84%E6%B6%88%E6%81%AF%E6%A0%BC%E5%BC%8F.25a0ncedd5q8.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/DNS%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84.7hndvbtcwfw0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.2a02covfhgg0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E5%8D%8F%E8%AE%AE%E6%A0%88.5xopofgapwc0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.4xe3gd1berk0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.je82ok2qyl4.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B.20u41re6htfk.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MTU%E4%B8%8EMSS.3o85r6ahv5g0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E5%89%B2.gfaixfjshcw.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E5%B1%82%E6%8A%A5%E6%96%87.27odcqs3krgg.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/IP%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.7j9ksgc202o0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E8%A1%A8.5mhlnr3ewy80.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E5%88%A4%E6%96%AD.y7pa4y507gg.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/IP%E5%B1%82%E6%8A%A5%E6%96%87.7ghca4wa2j80.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MAC%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.5pamiy0xprc0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/ARP%E5%B9%BF%E6%92%AD.678qvhv3o0g0.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/ARP%E7%BC%93%E5%AD%98%E5%86%85%E5%AE%B9.32lzyhi0nou0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MAC%E5%B1%82%E6%8A%A5%E6%96%87.3k1wjb2k23w0.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%89%A9%E7%90%86%E5%B1%82%E6%95%B0%E6%8D%AE%E5%8C%85.4fyz8eyjg8a0.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84MAC%E5%9C%B0%E5%9D%80%E8%A1%A8.2r70d27rpu20.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E5%99%A8%E8%BD%AC%E5%8F%91.10qs4sa9sc80.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E6%89%92%E7%9A%AE%E6%A8%A1%E5%9E%8B.pq62bqopiao.jpg"><meta property="article:published_time" content="2021-08-13T00:37:33.000Z"><meta property="article:modified_time" content="2021-08-13T02:16:23.131Z"><meta property="article:author" content="Wanyne W"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.1hxfibtd6mu8.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://wanyne-max.github.io/2021/08/13/%E8%BE%93%E5%85%A5%E7%BD%91%E5%9D%80%E4%B9%8B%E5%90%8E%E5%8F%91%E7%94%9F%E7%9A%84%E7%A7%8D%E7%A7%8D/"},"headline":"输入网址之后的种种","image":["https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.1hxfibtd6mu8.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/URL%E8%A7%A3%E6%9E%90.1qgqj3vqzdvk.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/HTTP%E7%9A%84%E6%B6%88%E6%81%AF%E6%A0%BC%E5%BC%8F.25a0ncedd5q8.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/DNS%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84.7hndvbtcwfw0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.2a02covfhgg0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E5%8D%8F%E8%AE%AE%E6%A0%88.5xopofgapwc0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.4xe3gd1berk0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.je82ok2qyl4.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B.20u41re6htfk.png","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MTU%E4%B8%8EMSS.3o85r6ahv5g0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E5%89%B2.gfaixfjshcw.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E5%B1%82%E6%8A%A5%E6%96%87.27odcqs3krgg.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/IP%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.7j9ksgc202o0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E8%A1%A8.5mhlnr3ewy80.png","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E5%88%A4%E6%96%AD.y7pa4y507gg.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/IP%E5%B1%82%E6%8A%A5%E6%96%87.7ghca4wa2j80.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MAC%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.5pamiy0xprc0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/ARP%E5%B9%BF%E6%92%AD.678qvhv3o0g0.png","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/ARP%E7%BC%93%E5%AD%98%E5%86%85%E5%AE%B9.32lzyhi0nou0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MAC%E5%B1%82%E6%8A%A5%E6%96%87.3k1wjb2k23w0.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%89%A9%E7%90%86%E5%B1%82%E6%95%B0%E6%8D%AE%E5%8C%85.4fyz8eyjg8a0.png","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84MAC%E5%9C%B0%E5%9D%80%E8%A1%A8.2r70d27rpu20.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E5%99%A8%E8%BD%AC%E5%8F%91.10qs4sa9sc80.jpg","https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E6%89%92%E7%9A%AE%E6%A8%A1%E5%9E%8B.pq62bqopiao.jpg"],"datePublished":"2021-08-13T00:37:33.000Z","dateModified":"2021-08-13T02:16:23.131Z","author":{"@type":"Person","name":"Wanyne W"},"publisher":{"@type":"Organization","name":"Wanyne's Blog","logo":{"@type":"ImageObject","url":"https://wanyne-max.github.io/img/logo.svg"}},"description":"在学习了部分网络知识后，我们可以大致的想象到在键入网址后，到网页显示出对应内容，其间发生了什么 接下来以简单的网络拓扑模型作为例子，探究一个数据包在网络中发生的种种。"}</script><link rel="canonical" href="https://wanyne-max.github.io/2021/08/13/%E8%BE%93%E5%85%A5%E7%BD%91%E5%9D%80%E4%B9%8B%E5%90%8E%E5%8F%91%E7%94%9F%E7%9A%84%E7%A7%8D%E7%A7%8D/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Wanyne&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-08-13T00:37:33.000Z" title="2021/8/13 上午8:37:33">2021-08-13</time>发表</span><span class="level-item"><time dateTime="2021-08-13T02:16:23.131Z" title="2021/8/13 上午10:16:23">2021-08-13</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></span><span class="level-item">1 小时读完 (大约7918个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">输入网址之后的种种</h1><div class="content"><p>在学习了部分网络知识后，我们可以大致的想象到在键入网址后，到网页显示出对应内容，其间发生了什么</p>
<p>接下来以简单的网络拓扑模型作为例子，探究一个数据包在网络中发生的种种。</p>
<p><escape><span id="more"></span></escape></p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B.1hxfibtd6mu8.jpg" alt="网络模型"></p>
</br>

<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><pre><code>浏览器做的第一步工作是解析 URL
</code></pre>
<p>首先浏览器做的第一步工作就是要对 <code>URL</code> 进行解析，从而生发送给 <code>Web 服务器</code>的请求信息。</p>
<p>让我们看看一条长长的 URL 里的各个元素的代表什么，见下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/URL%E8%A7%A3%E6%9E%90.1qgqj3vqzdvk.jpg" alt="URL解析"></p>
<p>所以图中的长长的 URL 实际上是请求服务器里的文件资源。</p>
<pre><code>要是上图中的蓝色部分 URL 元素都省略了，哪应该是请求哪个文件呢？
</code></pre>
<p>当没有路径名时，就代表访问根目录下事先设置的默认文件，也就是 <code>/index.html</code> 或者 <code>/default.html</code> 这些文件，这样就不会发生混乱了。</p>
</br>

<h2 id="生产-HTTP-请求信息"><a href="#生产-HTTP-请求信息" class="headerlink" title="生产 HTTP 请求信息"></a>生产 HTTP 请求信息</h2><p>对 <code>URL</code> 进行解析之后，浏览器确定了 Web 服务器和文件名，接下来就是根据这些信息来生成 HTTP 请求消息了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/HTTP%E7%9A%84%E6%B6%88%E6%81%AF%E6%A0%BC%E5%BC%8F.25a0ncedd5q8.jpg" alt="HTTP的消息格式"></p>
</br>

<h1 id="真实地址查询-——-DNS"><a href="#真实地址查询-——-DNS" class="headerlink" title="真实地址查询 —— DNS"></a>真实地址查询 —— DNS</h1><p>通过浏览器解析 URL 并生成 HTTP 消息后，需要委托操作系统将消息发送给 <code>Web 服务器</code>。</p>
<p>但在发送之前，还有一项工作需要完成，那就是<code>查询服务器域名对于的 IP 地址</code>，因为委托操作系统发送消息时，必须提供通信对象的 IP 地址。</p>
<p>比如我们打电话的时候，必须要知道对方的电话号码，但由于电话号码难以记忆，所以通常我们会将对方电话号 + 姓名保存在通讯录里。</p>
<p>所以，有一种服务器就专门保存了 Web 服务器<code>域名</code>与 <code>IP</code> 的对应关系，它就是 <code>DNS</code> 服务器。</p>
</br>

<h2 id="域名的层级关系"><a href="#域名的层级关系" class="headerlink" title="域名的层级关系"></a>域名的层级关系</h2><p>DNS 中的域名都是用<code>句点</code>来分隔的，比如 <code>www.server.com</code>，这里的句点代表了不同层次之间的<code>界限</code>。</p>
<p>在域名中，<code>越靠右</code>的位置表示其层级<code>越高</code>。</p>
<p>毕竟域名是外国人发明，所以思维和中国人相反，比如说一个城市地点的时候，外国喜欢从小到大的方式顺序说起（如 XX 街道 XX 区 XX 市 XX 省），而中国则喜欢从大到小的顺序（如 XX 省 XX 市 XX 区 XX 街道）。</p>
<p>根域是在最顶层，它的下一层就是 com 顶级域，再下面是 server.com。</p>
<p>所以域名的层级关系类似一个树状结构：</p>
<ul>
<li><p>根 DNS 服务器</p>
</li>
<li><p>顶级域 DNS 服务器（com）</p>
</li>
<li><p>权威 DNS 服务器（server.com）</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/DNS%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84.7hndvbtcwfw0.jpg" alt="DNS树状结构"></p>
<p>根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中。</p>
<p>这样一来，任何 DNS 服务器就都可以找到并访问根域 DNS 服务器了。</p>
<p>因此，客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器。</p>
</br>

<h2 id="域名解析的工作流程"><a href="#域名解析的工作流程" class="headerlink" title="域名解析的工作流程"></a>域名解析的工作流程</h2><ol>
<li><p>客户端首先会发出一个 DNS 请求，问 <a target="_blank" rel="noopener" href="http://www.server.com/">www.server.com</a> 的 IP 是啥，并发给本地 DNS 服务器（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。</p>
</li>
<li><p>本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 <a target="_blank" rel="noopener" href="http://www.server.com,则它直接返回/">www.server.com，则它直接返回</a> IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 <a target="_blank" rel="noopener" href="http://www.server.com/">www.server.com</a> 的 IP 地址吗？” 根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路。</p>
</li>
<li><p>根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“<a target="_blank" rel="noopener" href="http://www.server.com/">www.server.com</a> 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”</p>
</li>
<li><p>本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 <a target="_blank" rel="noopener" href="http://www.server.com/">www.server.com</a>  的 IP 地址吗？”</p>
</li>
<li><p>顶级域名服务器说：“我给你负责 <a target="_blank" rel="noopener" href="http://www.server.com/">www.server.com</a> 区域的权威 DNS 服务器的地址，你去问它应该能问到”。</p>
</li>
<li><p>本地 DNS 于是转向问权威 DNS 服务器：“老三，<a href="http://www.server.com对应的IP是啥呀？”">www.server.com对应的IP是啥呀？”</a> server.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。</p>
</li>
<li><p>权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。</p>
</li>
<li><p>本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。</p>
</li>
</ol>
<p>至此，我们完成了 DNS 的解析过程。现在总结一下，整个过程我画成了一个图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.2a02covfhgg0.jpg" alt="域名解析的工作流程"></p>
</br>

<h1 id="协议栈"><a href="#协议栈" class="headerlink" title="协议栈"></a>协议栈</h1><p>通过 DNS 获取到 IP 后，就可以把 HTTP 的传输工作交给操作系统中的<code>协议栈</code>。</p>
<p>协议栈的内部分为几个部分，分别承担不同的工作。上下关系是有一定的规则的，上面的部分会向下面的部分委托工作，下面的部分收到委托的工作并执行。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E5%8D%8F%E8%AE%AE%E6%A0%88.5xopofgapwc0.jpg" alt="协议栈"></p>
<p>应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。协议栈的上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，它们两会接受应用层的委托执行收发数据的操作。</p>
<p>协议栈的下面一半是用 IP 协议控制网络包收发操作，在互联网上传数据时，数据刽被切分成一块块的网络包，而将网络包发送给对方的操作就是由 IP 负责的。</p>
<p>此外 IP 中还包括 <code>ICMP</code> 协议和 <code>ARP</code> 协议。</p>
<ul>
<li><p>ICMP 用于告知网络包传送过程中产生的错误以及各种控制信息。</p>
</li>
<li><p>ARP 用于根据 IP 地址查询相应的以太网 MAC 地址。</p>
</li>
</ul>
<p>IP 下面的网卡驱动程序负责控制网卡硬件，而最下面的网卡则负责完成实际的收发操作，也就是对网线中的信号执行发送和接收操作。</p>
</br>

<h1 id="可靠传输-——-TCP"><a href="#可靠传输-——-TCP" class="headerlink" title="可靠传输 —— TCP"></a>可靠传输 —— TCP</h1><p>HTTP 是基于 TCP 协议传输的，所以在这我们先了解下 TCP 协议。</p>
</br>

<h2 id="TCP-包头格式"><a href="#TCP-包头格式" class="headerlink" title="TCP 包头格式"></a>TCP 包头格式</h2><p>我们先看看 TCP 报文头部的格式：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.4xe3gd1berk0.jpg" alt="TCP包头格式"></p>
<p>首先，<code>源端口号</code>和<code>目标端口号</code>是不可少的，如果没有这两个端口号，数据就不知道应该发给哪个应用。</p>
<p>接下来有包的<code>序号</code>，这个是为了解决包乱序的问题。</p>
<p>还有应该有的是<code>确认号</code>，目的是确认发出去对方是否有收到。如果没有收到就应该重新发送，直到送达，这个是为了解决不丢包的问题。</p>
<p>接下来还有一些<code>状态位</code>。例如 <code>SYN</code> 是发起一个连接，<code>ACK</code> 是回复，<code>RST</code> 是重新连接，<code>FIN</code> 是结束连接等。TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。</p>
<p>还有一个重要的就是<code>窗口大小</code>。TCP 要做<code>流量控制</code>，通信双方各声明一个窗口（缓存大小），标识自己当前能够的处理能力，别发送的太快，撑死我，也别发的太慢，饿死我。</p>
<p>除了做流量控制以外，TCP还会做<code>拥塞控制</code>，对于真正的通路堵车不堵车，它无能为力，唯一能做的就是控制自己，也即控制发送的速度。不能改变世界，就改变自己嘛。</p>
</br>

<h2 id="TCP-传输数据之前，要先三次握手建立连接"><a href="#TCP-传输数据之前，要先三次握手建立连接" class="headerlink" title="TCP 传输数据之前，要先三次握手建立连接"></a>TCP 传输数据之前，要先三次握手建立连接</h2><p>在 HTTP 传输数据之前，首先需要 TCP 建立连接，TCP 连接的建立，通常称为<code>三次握手</code>。</p>
<p>这个所谓的「连接」，只是双方计算机里维护一个状态机，在连接建立的过程中，双方的状态变化时序图就像这样。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.je82ok2qyl4.jpg" alt="TCP三次握手"></p>
<ul>
<li><p>一开始，客户端和服务端都处于 CLOSED 状态。先是服务端主动监听某个端口，处于 LISTEN 状态。</p>
</li>
<li><p>然后客户端主动发起连接 SYN，之后处于 SYN-SENT 状态。</p>
</li>
<li><p>服务端收到发起的连接，返回 SYN，并且 ACK 客户端的 SYN，之后处于 SYN-RCVD 状态。</p>
</li>
<li><p>客户端收到服务端发送的 SYN 和 ACK 之后，发送 ACK 的 ACK，之后处于 ESTABLISHED 状态，因为它一发一收成功了。</p>
</li>
<li><p>服务端收到 ACK 的 ACK 之后，处于 ESTABLISHED 状态，因为它也一发一收了。</p>
</li>
</ul>
<p>所以三次握手目的是<code>保证双方都有发送和接收的能力</code>。</p>
</br>

<h2 id="如何查看-TCP-的连接状态？"><a href="#如何查看-TCP-的连接状态？" class="headerlink" title="如何查看 TCP 的连接状态？"></a>如何查看 TCP 的连接状态？</h2><p>TCP 的连接状态查看，在 Linux 可以通过 <code>netstat -napt</code> 命令查看。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B.20u41re6htfk.png" alt="TCP连接状态查看"></p>
</br>

<h2 id="TCP-分割数据"><a href="#TCP-分割数据" class="headerlink" title="TCP 分割数据"></a>TCP 分割数据</h2><p>如果 HTTP 请求消息比较长，超过了 <code>MSS</code> 的长度，这时 TCP 就需要把 HTTP 的数据拆解一块块的数据发送，而不是一次性发送所有数据。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MTU%E4%B8%8EMSS.3o85r6ahv5g0.jpg" alt="MTU与MSS"></p>
<ul>
<li><p>MTU：一个网络包的最大长度，以太网中一般为 <code>1500</code> 字节。</p>
</li>
<li><p>MSS：除去 IP 和 TCP 头部之后，一个网络包所能容纳的 TCP 数据的最大长度。</p>
</li>
</ul>
<p>数据会被以 <code>MSS</code> 的长度为单位进行拆分，拆分出来的每一块数据都会被放进单独的网络包中。也就是在每个被拆分的数据加上 TCP 头信息，然后交给 IP 模块来发送数据。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E6%95%B0%E6%8D%AE%E5%8C%85%E5%88%86%E5%89%B2.gfaixfjshcw.jpg" alt="数据包分割"></p>
</br>

<h2 id="TCP-报文生成"><a href="#TCP-报文生成" class="headerlink" title="TCP 报文生成"></a>TCP 报文生成</h2><p>TCP 协议里面会有两个端口，一个是浏览器监听的端口（通常是随机生成的），一个是 Web 服务器监听的端口（HTTP 默认端口号是 <code>80</code>， HTTPS 默认端口号是 <code>443</code>）。</p>
<p>在双方建立了连接后，TCP 报文中的数据部分就是存放 HTTP 头部 + 数据，组装好 TCP 报文之后，就需交给下面的网络层处理。</p>
<p>至此，网络包的报文如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/TCP%E5%B1%82%E6%8A%A5%E6%96%87.27odcqs3krgg.jpg" alt="TCP层报文"></p>
</br>

<h1 id="远程定位-——-IP"><a href="#远程定位-——-IP" class="headerlink" title="远程定位 —— IP"></a>远程定位 —— IP</h1><p>TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成网络包发送给通信对象。</p>
</br>

<h2 id="IP-包头格式"><a href="#IP-包头格式" class="headerlink" title="IP 包头格式"></a>IP 包头格式</h2><p>我们先看看 IP 报文头部的格式：</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/IP%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.7j9ksgc202o0.jpg" alt="IP包头格式"></p>
<p>在 IP 协议里面需要有<code>源地址 IP</code> 和 <code>目标地址 IP</code>：</p>
<ul>
<li><p>源地址IP，即是客户端输出的 IP 地址；</p>
</li>
<li><p>目标地址，即通过 DNS 域名解析得到的 Web 服务器 IP。</p>
</li>
</ul>
<p>因为 HTTP 是经过 TCP 传输的，所以在 IP 包头的<code>协议号</code>，要填写为 <code>06</code>（十六进制），表示协议为 TCP。</p>
</br>

<h2 id="假设客户端有多个网卡，就会有多个-IP-地址，那-IP-头部的源地址应该选择哪个-IP-呢？"><a href="#假设客户端有多个网卡，就会有多个-IP-地址，那-IP-头部的源地址应该选择哪个-IP-呢？" class="headerlink" title="假设客户端有多个网卡，就会有多个 IP 地址，那 IP 头部的源地址应该选择哪个 IP 呢？"></a>假设客户端有多个网卡，就会有多个 IP 地址，那 IP 头部的源地址应该选择哪个 IP 呢？</h2><p>当存在多个网卡时，在填写源地址 IP 时，就需要判断到底应该填写哪个地址。这个判断相当于在多块网卡中判断应该使用哪个一块网卡来发送包。</p>
<p>这个时候就需要根据<code>路由表</code>规则，来判断哪一个网卡作为源地址 IP。</p>
<p>在 Linux 操作系统，我们可以使用 <code>route -n</code> 命令查看当前系统的路由表。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E8%A1%A8.5mhlnr3ewy80.png" alt="路由表"></p>
<p>举个例子，根据上面的路由表，我们假设 Web 服务器的目标地址是 <code>192.168.10.200</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E5%88%A4%E6%96%AD.y7pa4y507gg.jpg" alt="路由规则判断"></p>
<ol>
<li><p>首先先和第一条条目的子网掩码（<code>Genmask</code>）进行 <code>与运算</code>，得到结果为 <code>192.168.10.0</code>，但是第一个条目的 <code>Destination</code> 是 <code>192.168.3.0</code>，两者不一致所以匹配失败。</p>
</li>
<li><p>再与第二条目的子网掩码进行 <code>与运算</code>，得到的结果为 <code>192.168.10.0</code>，与第二条目的 <code>Destination 192.168.10.0</code> 匹配成功，所以将使用 <code>eth1</code> 网卡的 IP 地址作为 IP 包头的源地址。</p>
</li>
</ol>
<p>那么假设 Web 服务器的目标地址是 <code>10.100.20.100</code>，那么依然依照上面的路由表规则判断，判断后的结果是和第三条目匹配。</p>
<p>第三条目比较特殊，它目标地址和子网掩码都是 <code>0.0.0.0</code>，这表示默认网关，如果其他所有条目都无法匹配，就会自动匹配这一行。并且后续就把包发给路由器，<code>Gateway</code> 即是路由器的 IP 地址。</p>
</br>

<h2 id="IP-报文生成"><a href="#IP-报文生成" class="headerlink" title="IP 报文生成"></a>IP 报文生成</h2><p>至此，网络包的报文如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/IP%E5%B1%82%E6%8A%A5%E6%96%87.7ghca4wa2j80.jpg" alt="IP层报文"></p>
</br>

<h1 id="两点传输-——-MAC"><a href="#两点传输-——-MAC" class="headerlink" title="两点传输 —— MAC"></a>两点传输 —— MAC</h1><p>生成了 IP 头部之后，接下来网络包还需要在 IP 头部的前面加上 <code>MAC 头部</code>。</p>
</br>

<h2 id="MAC-包头格式"><a href="#MAC-包头格式" class="headerlink" title="MAC 包头格式"></a>MAC 包头格式</h2><p>MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MAC%E5%8C%85%E5%A4%B4%E6%A0%BC%E5%BC%8F.5pamiy0xprc0.jpg" alt="MAC包头格式"></p>
<p>在 MAC 包头里需要<code>发送方 MAC 地址</code>和<code>接收方目标 MAC 地址</code>，用于<code>两点之间的传输</code>。</p>
<p>一般在 TCP/IP 通信里，MAC 包头的<code>协议类型</code>只使用：</p>
<ul>
<li><p>0800 ：IP 协议</p>
</li>
<li><p>0806 ：ARP 协议</p>
</li>
</ul>
</br>

<h2 id="MAC-发送方和接收方如何确认"><a href="#MAC-发送方和接收方如何确认" class="headerlink" title="MAC 发送方和接收方如何确认?"></a>MAC 发送方和接收方如何确认?</h2><p><code>发送方</code>的 MAC 地址获取就比较简单了，MAC 地址是在网卡生产时写入到 ROM 里的，只要将这个值读取出来写入到 MAC 头部就可以了。</p>
<p><code>接收方</code>的 MAC 地址就有点复杂了，只要告诉以太网对方的 MAC 的地址，以太网就会帮我们把包发送过去，那么很显然这里应该填写对方的 MAC 地址。</p>
<p>所以先得搞清楚应该把包发给谁，这个只要查一下<code>路由表</code>就知道了。在路由表中找到相匹配的条目，然后把包发给 <code>Gateway</code> 列中的 IP 地址就可以了。</p>
</br>

<h2 id="既然知道要发给谁，按如何获取对方的-MAC-地址呢？"><a href="#既然知道要发给谁，按如何获取对方的-MAC-地址呢？" class="headerlink" title="既然知道要发给谁，按如何获取对方的 MAC 地址呢？"></a>既然知道要发给谁，按如何获取对方的 MAC 地址呢？</h2><p>不知道对方 MAC 地址？不知道就喊呗。</p>
<p>此时就需要 <code>ARP</code> 协议帮我们找到路由器的 MAC 地址。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/ARP%E5%B9%BF%E6%92%AD.678qvhv3o0g0.png" alt="ARP广播"></p>
<p>ARP 协议会在以太网中以<code>广播</code>的形式，对以太网所有的设备喊出：“这个 IP 地址是谁的？请把你的 MAC 地址告诉我”。</p>
<p>然后就会有人回答：“这个 IP 地址是我的，我的 MAC 地址是 XXXX”。</p>
<p>如果对方和自己处于同一个子网中，那么通过上面的操作就可以得到对方的 MAC 地址。然后，我们将这个 MAC 地址写入 MAC 头部，MAC 头部就完成了。</p>
</br>

<h2 id="每次都要广播获取，这不是很麻烦吗？"><a href="#每次都要广播获取，这不是很麻烦吗？" class="headerlink" title="每次都要广播获取，这不是很麻烦吗？"></a>每次都要广播获取，这不是很麻烦吗？</h2><p>放心，在后续操作系统会把本次查询结果放到一块叫做 <code>ARP 缓存</code>的内存空间留着以后用，不过缓存的时间就几分钟。</p>
<p>也就是说，在发包时：</p>
<ul>
<li><p>先查询 ARP 缓存，如果其中已经保存了对方的 MAC 地址，就不需要发送 ARP 查询，直接使用 ARP 缓存中的地址。</p>
</li>
<li><p>而当 ARP 缓存中不存在对方 MAC 地址时，则发送 ARP 广播查询。</p>
</li>
</ul>
</br>

<h2 id="查看-ARP-缓存内容"><a href="#查看-ARP-缓存内容" class="headerlink" title="查看 ARP 缓存内容"></a>查看 ARP 缓存内容</h2><p>在 Linux 系统中，我们可以使用 <code>arp -a</code> 命令来查看 ARP 缓存的内容。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/ARP%E7%BC%93%E5%AD%98%E5%86%85%E5%AE%B9.32lzyhi0nou0.jpg" alt="ARP缓存内容"></p>
<h2 id="MAC-报文生成"><a href="#MAC-报文生成" class="headerlink" title="MAC 报文生成"></a>MAC 报文生成</h2><p>至此，网络包的报文如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/MAC%E5%B1%82%E6%8A%A5%E6%96%87.3k1wjb2k23w0.jpg" alt="MAC层报文"></p>
</br>

<h1 id="出口-——-网卡"><a href="#出口-——-网卡" class="headerlink" title="出口 —— 网卡"></a>出口 —— 网卡</h1><p>IP 生成的网络包只是存放在内存中的一串二进制数字信息，没有办法直接发送给对方。因此，我们需要将<code>数字信息转换为电信号</code>，才能在网线上传输，也就是说，这才是真正的数据发送过程。</p>
<p>负责执行这一操作的是<code>网卡</code>，要控制网卡还需要靠<code>网卡驱动程序</code>。</p>
<p>网卡驱动从 IP 模块获取到包之后，会将其<code>复制</code>到网卡内的缓存区中，接着会其<code>开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E7%89%A9%E7%90%86%E5%B1%82%E6%95%B0%E6%8D%AE%E5%8C%85.4fyz8eyjg8a0.png" alt="物理层数据包"></p>
<ul>
<li><p>起始帧分界符是一个用来表示包起始位置的标记</p>
</li>
<li><p>末尾的 FCS（帧校验序列）用来检查包传输过程是否有损坏</p>
</li>
</ul>
<p>最后网卡会将包转为电信号，通过网线发送出去。</p>
</br>

<h1 id="送别者-——-交换机"><a href="#送别者-——-交换机" class="headerlink" title="送别者 —— 交换机"></a>送别者 —— 交换机</h1><p>下面来看一下包是如何通过交换机的。交换机的设计是将网络包<code>原样</code>转发到目的地。交换机工作在 MAC 层，也称为<code>二层网络设备</code>。</p>
</br>

<h2 id="交换机的包接收操作"><a href="#交换机的包接收操作" class="headerlink" title="交换机的包接收操作"></a>交换机的包接收操作</h2><p>首先，电信号到达网线接口，交换机里的模块进行接收，接下来交换机里的模块将电信号转换为数字信号。</p>
<p>然后通过包末尾的 <code>FCS</code> 校验错误，如果没问题则放到缓冲区。这部分操作基本和计算机的网卡相同，但交换机的工作方式和网卡不同。</p>
<p>计算机的网卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是发给自己的则丢弃；相对地，交换机的端口不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。因此，和网卡不同，<code>交换机的端口不具有 MAC 地址</code>。</p>
<p>将包存入缓冲区后，接下来需要查询一下这个包的接收方 MAC 地址是否已经在 MAC 地址表中有记录了。</p>
<p>交换机的 MAC 地址表主要包含两个信息：</p>
<ul>
<li><p>一个是设备的 MAC 地址，</p>
</li>
<li><p>另一个是该设备连接在交换机的哪个端口上。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84MAC%E5%9C%B0%E5%9D%80%E8%A1%A8.2r70d27rpu20.jpg" alt="交换机的MAC地址表"></p>
<p>举个例子，如果收到的包的接收方 MAC 地址为 <code>00-02-B3-1C-9C-F9</code>，则与图中表中的第 3 行匹配，根据端口列的信息，可知这个地址位于 <code>3</code> 号端口上，然后就可以通过交换电路将包发送到相应的端口了。</p>
<p>所以，<code>交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口</code>。</p>
</br>

<h2 id="当-MAC-地址表找不到指定的-MAC-地址会怎么样？"><a href="#当-MAC-地址表找不到指定的-MAC-地址会怎么样？" class="headerlink" title="当 MAC 地址表找不到指定的 MAC 地址会怎么样？"></a>当 MAC 地址表找不到指定的 MAC 地址会怎么样？</h2><p>地址表中找不到指定的 MAC 地址。这可能是因为具有该地址的设备还没有向交换机发送过包，或者这个设备一段时间没有工作导致地址被从地址表中删除了。</p>
<p>这种情况下，交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口上，无论该设备连接在哪个端口上都能收到这个包。</p>
<p>这样做不会产生什么问题，因为以太网的设计本来就是将包发送到整个网络的，然后<code>只有相应的接收者才接收包，而其他设备则会忽略这个包</code>。</p>
<p>有人会说：“这样做会发送多余的包，会不会造成网络拥塞呢？”</p>
<p>其实完全不用过于担心，因为发送了包之后目标设备会作出响应，只要返回了响应包，交换机就可以将它的地址写入 MAC 地址表，下次也就不需要把包发到所有端口了。</p>
<p>局域网中每秒可以传输上千个包，多出一两个包并无大碍。</p>
<p>此外，如果接收方 MAC 地址是一个<code>广播地址</code>，那么交换机会将包发送到除源端口之外的所有端口。</p>
<p>以下两个属于广播地址：</p>
<ul>
<li><p>MAC 地址中的 FF:FF:FF:FF:FF:FF</p>
</li>
<li><p>IP 地址中的 255.255.255.255</p>
</li>
</ul>
</br>

<h2 id="出境大门-——-路由器"><a href="#出境大门-——-路由器" class="headerlink" title="出境大门 —— 路由器"></a>出境大门 —— 路由器</h2></br>

<h2 id="路由器与交换机的区别"><a href="#路由器与交换机的区别" class="headerlink" title="路由器与交换机的区别"></a>路由器与交换机的区别</h2><p>网络包经过交换机之后，现在到达了<code>路由器</code>，并在此被转发到下一个路由器或目标设备。</p>
<p>这一步转发的工作原理和交换机类似，也是通过查表判断包转发的目标。</p>
<p>不过在具体的操作过程上，路由器和交换机是有区别的。</p>
<ul>
<li><p>因为<code>路由器</code>是基于 IP 设计的，俗称<code>三层</code>网络设备，路由器的各个端口都具有 MAC 地址和 IP 地址；</p>
</li>
<li><p>而<code>交换机</code>是基于以太网设计的，俗称<code>二层</code>网络设备，交换机的端口不具有 MAC 地址。</p>
</li>
</ul>
</br>

<h2 id="路由器基本原理"><a href="#路由器基本原理" class="headerlink" title="路由器基本原理"></a>路由器基本原理</h2><p>路由器的端口具有 MAC 地址，因此它就能够成为以太网的发送方和接收方；同时还具有 IP 地址，从这个意义上来说，它和计算机的网卡是一样的。</p>
<p>当转发包时，首先路由器端口会接收发给自己的以太网包，然后<code>路由表</code>查询转发目标，再由相应的端口作为发送方将以太网包发送出去。</p>
</br>

<h2 id="路由器的包接收操作"><a href="#路由器的包接收操作" class="headerlink" title="路由器的包接收操作"></a>路由器的包接收操作</h2><p>首先，电信号到达网线接口部分，路由器中的模块会将电信号转成数字信号，然后通过包末尾的 FCS 进行错误校验。</p>
<p>如果没问题则检查 MAC 头部中的<code>接收方 MAC 地址</code>，看看是不是发给自己的包，如果是就放到接收缓冲区中，否则就丢弃这个包。</p>
<p>总的来说，路由器的端口都具有 MAC 地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃。</p>
</br>

<h2 id="查询路由表确定输出端口"><a href="#查询路由表确定输出端口" class="headerlink" title="查询路由表确定输出端口"></a>查询路由表确定输出端口</h2><p>完成包接收操作之后，路由器就会<code>去掉</code>包开头的 MAC 头部。</p>
<p><code>MAC 头部的作用就是将包送达路由器</code>，其中的接收方 MAC 地址就是路由器端口的 MAC 地址。因此，当包到达路由器之后，MAC 头部的任务就完成了，于是 MAC 头部就会<code>被丢弃</code>。</p>
<p>接下来，路由器会根据 MAC 头部后方的 <code>IP</code> 头部中的内容进行包的转发操作。</p>
<p>转发操作分为几个阶段，首先是查询<code>路由表</code>判断转发目标。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E8%B7%AF%E7%94%B1%E5%99%A8%E8%BD%AC%E5%8F%91.10qs4sa9sc80.jpg" alt="路由器转发"></p>
<p>具体的工作流程根据上图，举个例子。</p>
<p>假设地址为 <code>10.10.1.101</code> 的计算机要向地址为 <code>192.168.1.100</code> 的服务器发送一个包，这个包先到达图中的路由器。</p>
<p>判断转发目标的第一步，就是根据包的接收方 IP 地址查询路由表中的目标地址栏，以找到相匹配的记录。</p>
<p>路由匹配和前面讲的一样，每个条目的子网掩码和 <code>192.168.1.100</code> IP 做 <code>&amp; 与运算</code>后，得到的结果与对应条目的目标地址进行匹配，如果匹配就会作为候选转发目标，如果不匹配就继续与下个条目进行路由匹配。</p>
<p>如第二条目的子网掩码 <code>255.255.255.0</code> 与 <code>192.168.1.100</code> IP 做 <code>&amp; 与运算</code>后，得到结果是 <code>192.168.1.0</code> ，这与第二条目的目标地址 <code>192.168.1.0</code> 匹配，该第二条目记录就会被作为转发目标。</p>
<p>实在找不到匹配路由时，就会选择<code>默认路由</code>，路由表中子网掩码为 0.0.0.0 的记录表示「默认路由」。</p>
</br>

<h2 id="路由器的发送操作"><a href="#路由器的发送操作" class="headerlink" title="路由器的发送操作"></a>路由器的发送操作</h2><p>接下来就会进入包的<code>发送操作</code>。</p>
<p>首先，我们需要根据<code>路由表的网关列</code>判断对方的地址。</p>
<p>如果网关是一个 IP 地址，则这个IP 地址就是我们要转发到的目标地址，还<code>未抵达终点</code>，还需继续需要路由器转发。</p>
<p>如果网关为空，则 IP 头部中的接收方 IP 地址就是要转发到的目标地址，也是就终于找到 IP 包头里的目标地址了，说明<code>已抵达终点</code>。</p>
<p>知道对方的 IP 地址之后，接下来需要通过 <code>ARP</code> 协议根据 IP 地址查询 MAC 地址，并将查询的结果作为接收方 MAC 地址。</p>
<p>路由器也有 ARP 缓存，因此首先会在 ARP 缓存中查询，如果找不到则发送 ARP 查询请求。</p>
<p>接下来是发送方 MAC 地址字段，这里填写输出端口的 MAC 地址。还有一个以太类型字段，填写 0080 （十六进制）表示 IP 协议。</p>
<p>网络包完成后，接下来会将其转换成电信号并通过端口发送出去。这一步的工作过程和计算机也是相同的。</p>
<p>发送出去的网络包会通过<code>交换机</code>到达下一个路由器。由于接收方 MAC 地址就是下一个路由器的地址，所以交换机会根据这一地址将包传输到下一个路由器。</p>
<p>接下来，下一个路由器会将包转发给再下一个路由器，经过层层转发之后，网络包就到达了最终的目的地。</p>
<p>不知你发现了没有，在网络包传输的过程中，<code>源 IP 和目标 IP 始终是不会变的，一直变化的是 MAC 地址</code>，因为需要 MAC 地址在以太网内进行<code>两个设备</code>之间的包传输。</p>
</br>

<h1 id="互相扒皮-——-服务器-与-客户端"><a href="#互相扒皮-——-服务器-与-客户端" class="headerlink" title="互相扒皮 —— 服务器 与 客户端"></a>互相扒皮 —— 服务器 与 客户端</h1><p>数据包抵达了服务器，服务器肯定高兴呀，正所谓有朋自远方来，不亦乐乎？</p>
<p>服务器高兴的不得了，于是开始扒数据包的皮！就好像你收到快递，能不兴奋吗？</p>
<p><img src="https://cdn.jsdelivr.net/gh/wanyne-max/image-host@master/http/%E6%89%92%E7%9A%AE%E6%A8%A1%E5%9E%8B.pq62bqopiao.jpg" alt="扒皮模型"></p>
<p>数据包抵达服务器后，服务器会先扒开数据包的 MAC 头部，查看是否和服务器自己的 MAC 地址符合，符合就将包收起来。</p>
<p>接着继续扒开数据包的 IP 头，发现 IP 地址符合，根据 IP 头中协议项，知道自己上层是 TCP 协议。</p>
<p>于是，扒开 TCP 的头，里面有序列号，需要看一看这个序列包是不是我想要的，如果是就放入缓存中然后返回一个 ACK，如果不是就丢弃。TCP头部里面还有端口号， HTTP 的服务器正在监听这个端口号。</p>
<p>于是，服务器自然就知道是 HTTP 进程想要这个包，于是就将包发给 HTTP 进程。</p>
<p>服务器的 HTTP 进程看到，原来这个请求是要访问一个页面，于是就把这个网页封装在 HTTP 响应报文里。</p>
<p>HTTP 响应报文也需要穿上 TCP、IP、MAC 头部，不过这次是源地址是服务器 IP 地址，目的地址是客户端 IP 地址。</p>
<p>穿好头部衣服后，从网卡出去，交由交换机转发到出城的路由器，路由器就把响应数据包发到了下一个路由器，就这样跳啊跳。</p>
<p>最后跳到了客户端的城门把手的路由器，路由器扒开 IP 头部发现是要找城内的人，于是把包发给了城内的交换机，再由交换机转发到客户端。</p>
<p>客户端收到了服务器的响应数据包后，同样也非常的高兴，客户能拆快递了！</p>
<p>于是，客户端开始扒皮，把收到的数据包的皮扒剩 HTTP 响应报文后，交给浏览器去渲染页面，一份特别的数据包快递，就这样显示出来了！</p>
<p>最后，客户端要离开了，向服务器发起了 TCP 四次挥手，至此双方的连接就断开了。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>输入网址之后的种种</p><p><a href="https://wanyne-max.github.io/2021/08/13/输入网址之后发生的种种/">https://wanyne-max.github.io/2021/08/13/输入网址之后发生的种种/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Wanyne W</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-08-13</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-08-13</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/08/22/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%AC%94%E8%AE%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">正则表达式笔记</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/08/08/UTC-UT-GMT%20%20%E6%97%B6%E5%8C%BA%E5%92%8C%E6%97%B6%E9%97%B4%E6%88%B3/"><span class="level-item">UTC-UT-GMT  时区和时间戳</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.png" alt="Wanyne W"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Wanyne W</p><p class="is-size-6 is-block">所有命运的馈赠 早已暗中标注了价格</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Blog/"><span class="level-start"><span class="level-item">Blog</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Redis/"><span class="level-start"><span class="level-item">Redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/SQL/"><span class="level-start"><span class="level-item">SQL</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><span class="level-start"><span class="level-item">学习笔记</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%9F%A5%E8%AF%86%E5%8C%BA/"><span class="level-start"><span class="level-item">知识区</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">网络</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-01T18:22:22.000Z">2022-02-02</time></p><p class="title"><a href="/2022/02/02/JVM-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">JVM-垃圾回收</a></p><p class="categories"><a href="/categories/%E7%9F%A5%E8%AF%86%E5%8C%BA/">知识区</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-01T18:22:22.000Z">2022-02-02</time></p><p class="title"><a href="/2022/02/02/JVM-%E5%86%85%E5%AD%98/">JVM-内存</a></p><p class="categories"><a href="/categories/%E7%9F%A5%E8%AF%86%E5%8C%BA/">知识区</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-01T18:22:22.000Z">2022-02-02</time></p><p class="title"><a href="/2022/02/02/Spring/">Spring</a></p><p class="categories"><a href="/categories/%E7%9F%A5%E8%AF%86%E5%8C%BA/">知识区</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-01T18:22:22.000Z">2022-02-02</time></p><p class="title"><a href="/2022/02/02/Redis/">Redis</a></p><p class="categories"><a href="/categories/%E7%9F%A5%E8%AF%86%E5%8C%BA/">知识区</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-02-01T18:22:22.000Z">2022-02-02</time></p><p class="title"><a href="/2022/02/02/SpringBoot/">SpringBoot</a></p><p class="categories"><a href="/categories/%E7%9F%A5%E8%AF%86%E5%8C%BA/">知识区</a></p></div></article></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Wanyne&#039;s Blog" height="28"></a><p class="is-size-7">   <span>&copy; 2022 Wanyne W</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Made by Wanyne W</p><p class="is-size-7">Hope you have a good day！ ♥</p><p class="is-size-7">Creation date : 2021 08 05</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>